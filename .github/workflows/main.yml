name: Build and Release Extension

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-release:
    name: Build and Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Set up pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install

      - name: Make build.sh executable
        run: chmod +x ./build.sh

      - name: Run build script
        run: ./build.sh

      - name: Collect Git Info
        id: gitinfo
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "build_time=$(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
          
          COMMIT_LOG=$(git log -n 5 --pretty=format:"- %s (%an)" | tr '\n' '~')
          echo "commits=${COMMIT_LOG}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          files: |
            .output/*-chrome.zip
            .output/*-firefox.zip
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ## ğŸ» Bark Sender New Release | æ–°ç‰ˆå‘å¸ƒ

            - **Firefox Extension**: `bark-sender-*-firefox.zip`  
            - **Chrome/Edge Extension**: `bark-sender-*-chrome.zip`

            ### ğŸ“‹ Installation Guide
            1. Download the appropriate extension zip  
            2. Extract to a local folder  
            3. Go to your browser's extension page, enable "Load unpacked"  
            4. Select the extracted folder to install

            ---

            âœ… **Build Info**
            - Commit: ${{ steps.gitinfo.outputs.sha_short }}
            - Build Time: ${{ steps.gitinfo.outputs.build_time }}

            ---

            - **Firefox æ‰©å±•**: `bark-sender-*-firefox.zip`  
            - **Chrome/Edge æ‰©å±•**: `bark-sender-*-chrome.zip`

            ### ğŸ“‹ å®‰è£…è¯´æ˜
            1. ä¸‹è½½å¯¹åº”æµè§ˆå™¨çš„æ‰©å±•åŒ…  
            2. è§£å‹ç¼©åˆ°æœ¬åœ°æ–‡ä»¶å¤¹  
            3. åœ¨æµè§ˆå™¨æ‰©å±•ç®¡ç†é¡µé¢é€‰æ‹©"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº"  
            4. é€‰æ‹©è§£å‹åçš„æ–‡ä»¶å¤¹å³å¯å®‰è£…

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bark-sender-extensions-${{ steps.gitinfo.outputs.sha_short }}
          path: .output/*.zip
          retention-days: 30
          include-hidden-files: true

