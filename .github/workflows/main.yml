name: Build and Release Extension

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-release:
    name: Build and Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Set up pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install

      - name: Make build.sh executable
        run: chmod +x ./build.sh

      - name: Run build script
        run: ./build.sh

      - name: Collect Git Info
        id: gitinfo
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "build_time=$(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

          git fetch --tags --force

          PREVIOUS_TAG=$(git describe --tags --abbrev=0 $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")

          if [ -n "$PREVIOUS_TAG" ]; then
            # æ¯è¡Œæ˜¾ç¤ºçŸ­SHAã€æäº¤ä¿¡æ¯å’Œä½œè€…
            COMMIT_LOG=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %h %s (%an)")
            echo "previous_tag=${PREVIOUS_TAG}" >> $GITHUB_OUTPUT
          else
            COMMIT_LOG=$(git log -n 5 --pretty=format:"- %h %s (%an)")
            echo "previous_tag=Initial Release" >> $GITHUB_OUTPUT
          fi

          {
            echo "commits<<EOF"
            echo "$COMMIT_LOG"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          files: |
            .output/*-chrome.zip
            .output/*-firefox.zip
            .output/*-edge.zip
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ## ğŸ» NoLet Sender New Release | æ–°ç‰ˆå‘å¸ƒ

            - **Firefox**: `nolet-sender-*-firefox.zip`  
            - **Chrome**: `nolet-sender-*-chrome.zip`
            - **Edge**: `nolet-sender-*-edge.zip`

            ### ğŸ“– Installation Guide | å®‰è£…è¯´æ˜
            1. Download the appropriate extension zip | ä¸‹è½½å¯¹åº”æµè§ˆå™¨çš„æ‰©å±•åŒ…  
            2. Extract to a local folder | è§£å‹ç¼©åˆ°æœ¬åœ°æ–‡ä»¶å¤¹  
            3. Go to your browser's extension page, enable "Load unpacked" | åœ¨æµè§ˆå™¨æ‰©å±•ç®¡ç†é¡µé¢é€‰æ‹©"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº"  
            4. Select the extracted folder to install | é€‰æ‹©è§£å‹åçš„æ–‡ä»¶å¤¹å³å¯å®‰è£…

            ---

            ### ğŸ“ Changes Since ${{ steps.gitinfo.outputs.previous_tag }} | æ›´æ–°å†…å®¹
            ${{ steps.gitinfo.outputs.commits }}

            ---

            âœ… **Build Info | æ„å»ºä¿¡æ¯**
            - Current Commit: ${{ steps.gitinfo.outputs.sha_short }}
            - Build Time: ${{ steps.gitinfo.outputs.build_time }}

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nolet-sender-extensions-${{ steps.gitinfo.outputs.sha_short }}
          path: .output/*.zip
          retention-days: 30
          include-hidden-files: true

